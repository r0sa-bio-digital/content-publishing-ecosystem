<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/r0sa-bio-digital/meslo@1.0.0/meslo.css">
        <script>
            console.info('welcome to c0ntent');
            const apiUrl = 'https://c0ntent.herokuapp.com/';
            async function onLoad()
            {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken)
                    document.getElementById('login').style.display = 'block';
                else
                {
                    document.getElementById('loading').style.display = 'block';
                    const loginResponse = await fetch(
                        apiUrl + 'user/login',
                        {
                            method: 'GET',
                            headers: {
                                Authorization: `Basic ${btoa(accessToken + ':')}`
                            }
                        }
                    );
                    if (loginResponse.status === 200)
                    {
                        const userData = await loginResponse.json();
                        document.getElementById('accountId').textContent = userData.id;
                        document.getElementById('accountName').textContent = userData.name;
                        document.getElementById('account').style.display = 'block';
                    }
                    else
                        document.getElementById('failed').style.display = 'block';

                }
            }
            function onLoginClick()
            {
                localStorage.setItem('accessToken', document.getElementById('accessTokenInput').value);
                document.getElementById('login').style.display = 'none';
                onLoad();
            }
            function onResetClick()
            {
                localStorage.removeItem('accessToken');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('failed').style.display = 'none';
                document.getElementById('account').style.display = 'none';
                onLoad();
            }
            async function onRefreshBalanceClick()
            {
                const balanceElement = document.getElementById('accountBalance');
                balanceElement.textContent = '...';
                const accessToken = localStorage.getItem('accessToken');
                const balanceResponse = await fetch(
                    apiUrl + 'user/balance',
                    {
                        method: 'GET',
                        headers: {
                            Authorization: `Basic ${btoa(accessToken + ':')}`
                        }
                    }
                );
                if (balanceResponse.status === 200)
                {
                    const balanceData = await balanceResponse.json();
                    balanceElement.textContent = balanceData.amountText + ' ' + balanceData.currency;
                }
                else
                    balanceElement.textContent = 'failed';
            }
            async function onRefreshExchangeRatesClick()
            {
                const ratesElement = document.getElementById('exchangeRatesTableBody');
                ratesElement.innerHTML = '<tr><td>...</td><td></td></tr>';
                const accessToken = localStorage.getItem('accessToken');
                const ratesResponse = await fetch(
                    apiUrl + 'currency/exchange/rates',
                    {
                        method: 'GET',
                        headers: {
                            Authorization: `Basic ${btoa(accessToken + ':')}`
                        }
                    }
                );

                if (ratesResponse.status === 200)
                {
                    const ratesData = await ratesResponse.json();
                    let html = '';
                    for (let i = 0; i < ratesData.length; ++i)
                        html += `<tr><td>${ratesData[i].name}</td><td style="text-align: right;">${ratesData[i].rateText}</td></tr>`;
                    ratesElement.innerHTML = html;
                }
                else
                    ratesElement.innerHTML = '<tr><td>failed</td><td></td></tr>';
            }
            async function onRefreshTransactionHistoryClick()
            {
                const historyElement = document.getElementById('transactionHistoryTableBody');
                historyElement.innerHTML = '<tr><td>...</td><td></td><td></td><td></td></tr>';
                const accessToken = localStorage.getItem('accessToken');
                const historyResponse = await fetch(
                    apiUrl + 'user/transactions/history',
                    {
                        method: 'GET',
                        headers: {
                            Authorization: `Basic ${btoa(accessToken + ':')}`
                        }
                    }
                );
                if (historyResponse.status === 200)
                {
                    const historyData = await historyResponse.json();
                    const external_currency_ids = {};
                    for (let i = 0; i < historyData.length; ++i)
                    {
                        const id = historyData[i].external_currency_id;
                        if (id)
                            external_currency_ids[id] = true;
                    }
                    const currencyNames = {};
                    for (let knitId in currencyNames)
                    {
                        const knitResponse = await fetch(
                            apiUrl + knitId + '/read/text',
                            {
                                method: 'GET',
                                headers: {
                                    Authorization: `Basic ${btoa(accessToken + ':')}`
                                }
                            }
                        );
                        if (knitResponse.status === 200)
                        {
                            const knitData = await knitResponse.json();
                            currencyNames[knitId] = knitData;
                        }
                    }
                    let html = '';
                    for (let i = 0; i < historyData.length; ++i)
                    {
                        const sign = historyData[i].debited_account === accessToken ? '-' :
                            historyData[i].credited_account === accessToken ? '+' :
                                '?';
                        const color = sign === '-' ? 'red' :
                            sign === '+' ? 'green' :
                                'black';
                        const externalDirection = sign === '-' ? '>>' :
                            sign === '+' ? '<<' :
                                '..';
                        const external = historyData[i].external_amount && historyData[i].external_currency_id ?
                            externalDirection + ' ' + historyData[i].external_amount + ' ' + currencyNames[historyData[i].external_currency_id] : '';
                        html += `<tr><td>${historyData[i].creation}</td><td style="text-align: center; color: ${color}">${sign}</td><td style="text-align: right; color: ${color}">${historyData[i].c01n_amount}</td><td>${external}</td></tr>`;
                    }
                    historyElement.innerHTML = html;
                }
                else
                    historyElement.innerHTML = '<tr><td>failed</td><td></td><td></td><td></td></tr>';
            }
        </script>
    </head>
    <body onload="onLoad();">
        <div id="login" style="display: none;">
            <label for="accessTokenInput">access token: </label><input id="accessTokenInput" type="text">
            <button onclick="onLoginClick();">login</button>
        </div>
        <div id="loading" style="display: none;">
            loading...
        </div>
        <div id="account" style="display: none;">
            <div>
                <span>id: </span><span id="accountId"></span>
            </div>
            <div>
                <span>name: </span><span id="accountName"></span>
                <button onclick="onResetClick();">logout</button>
            </div>
            <div>
                <span>balance: </span><span id="accountBalance">?</span>
                <button onclick="onRefreshBalanceClick();">refresh</button>
            </div>
            <div>
                <span>exchange rates: </span>
                <button onclick="onRefreshExchangeRatesClick();">refresh</button>
                <table id="exchangeRatesTable">
                    <thead>
                        <td>currency</td>
                        <td>value in c01ns</td>
                    </thead>
                    <tbody id="exchangeRatesTableBody">
                    </tbody>
                </table>
            </div>
            <div>
                <span>transaction history: </span>
                <button onclick="onRefreshTransactionHistoryClick();">refresh</button>
                <table id="transactionHistoryTable">
                    <thead>
                        <td>date</td>
                        <td>Â±</td>
                        <td>amount</td>
                        <td>external</td>
                    </thead>
                    <tbody id="transactionHistoryTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="failed" style="display: none;">
            <span>login failed</span>
            <button onclick="onResetClick();">reset</button>
        </div>
    </body>
</html>