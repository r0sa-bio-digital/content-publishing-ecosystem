<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/r0sa-bio-digital/meslo@1.0.0/meslo.css">
        <script>
            console.info('welcome to c0ntent');
            const apiUrl = 'https://c0ntent.herokuapp.com/';
            async function onLoad()
            {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken)
                    document.getElementById('login').style.display = 'block';
                else
                {
                    document.getElementById('loading').style.display = 'block';
                    const loginResponse = await fetch(
                        apiUrl + 'user/login',
                        {
                            method: 'GET',
                            headers: {
                                Authorization: `Basic ${btoa(accessToken + ':')}`
                            }
                        }
                    );
                    if (loginResponse.status === 200)
                    {
                        const userData = await loginResponse.json();
                        document.getElementById('accountId').textContent = userData.id;
                        document.getElementById('accountName').textContent = userData.name;
                        document.getElementById('account').style.display = 'block';
                    }
                    else
                        document.getElementById('failed').style.display = 'block';

                }
            }
            function onLoginClick()
            {
                localStorage.setItem('accessToken', document.getElementById('accessTokenInput').value);
                document.getElementById('login').style.display = 'none';
                onLoad();
            }
            function onResetClick()
            {
                localStorage.removeItem('accessToken');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('failed').style.display = 'none';
                document.getElementById('account').style.display = 'none';
                onLoad();
            }
            async function onRefreshBalanceClick()
            {
                const balanceElement = document.getElementById('accountBalance');
                balanceElement.textContent = '...';
                const accessToken = localStorage.getItem('accessToken');
                const balanceResponse = await fetch(
                    apiUrl + 'user/balance',
                    {
                        method: 'GET',
                        headers: {
                            Authorization: `Basic ${btoa(accessToken + ':')}`
                        }
                    }
                );
                if (balanceResponse.status === 200)
                {
                    const balanceData = await balanceResponse.json();
                    balanceElement.textContent = balanceData.amountText + ' ' + balanceData.currency;
                }
                else
                    balanceElement.textContent = 'failed';
            }
            async function onRefreshExchangeRatesClick()
            {
                const ratesElement = document.getElementById('exchangeRatesTableBody');
                ratesElement.innerHtml = '<tr><td>...</td><td>...</td></tr>';
                const accessToken = localStorage.getItem('accessToken');
                const ratesResponse = await fetch(
                    apiUrl + 'currency/exchange/rates',
                    {
                        method: 'GET',
                        headers: {
                            Authorization: `Basic ${btoa(accessToken + ':')}`
                        }
                    }
                );

                if (ratesResponse.status === 200)
                {
                    const ratesData = await ratesResponse.json();
                    let html = '';
                    for (let = 0; i < ratesData.length; ++i)
                        html += `<tr><td>${ratesData[i].name}</td><td>${ratesData[i].rateText}</td></tr>`;
                    ratesElement.innerHtml = html;
                }
                else
                    ratesElement.innerHtml = '<tr><td>failed</td><td>failed</td></tr>';
            }
            async function onRefreshTransactionHistoryClick()
            {
                ;
            }
        </script>
    </head>
    <body onload="onLoad();">
        <div id="login" style="display: none;">
            <label for="accessTokenInput">access token: </label><input id="accessTokenInput" type="text">
            <button onclick="onLoginClick();">login</button>
        </div>
        <div id="loading" style="display: none;">
            loading...
        </div>
        <div id="account" style="display: none;">
            <div>
                <span>id: </span><span id="accountId"></span>
            </div>
            <div>
                <span>name: </span><span id="accountName"></span>
                <button onclick="onResetClick();">logout</button>
            </div>
            <div>
                <span>balance: </span><span id="accountBalance">?</span>
                <button onclick="onRefreshBalanceClick();">refresh</button>
            </div>
            <div>
                <span>exchange rates: </span>
                <button onclick="onRefreshExchangeRatesClick();">refresh</button>
                <table id="exchangeRatesTable">
                    <thead>
                        <td>currency</td>
                        <td>value in c01ns</td>
                    </thead>
                    <tbody id="exchangeRatesTableBody">
                    </tbody>
                </table>
            </div>
            <div>
                <span>transaction history: </span>
                <button onclick="onRefreshTransactionHistoryClick();">refresh</button>
                <table id="transactionHistoryTable">
                </table>
            </div>
        </div>
        <div id="failed" style="display: none;">
            <span>login failed</span>
            <button onclick="onResetClick();">reset</button>
        </div>
    </body>
</html>